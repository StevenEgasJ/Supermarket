<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - El Valle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="./static/css/admin.css">
    <link rel="stylesheet" href="./static/css/invoice-edit.css">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="./static/img/logo.png" alt="El Valle" height="40">
                El Valle - Admin
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fa-solid fa-user-shield me-2"></i>
                        <span id="adminName">Administrador</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="index.html"><i class="fa-solid fa-home me-2"></i>Ir a la tienda</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()"><i class="fa-solid fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-content">
                    <h5 class="sidebar-title">Panel de Control</h5>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showDashboard()">
                                <i class="fa-solid fa-chart-line me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showProducts()">
                                <i class="fa-solid fa-box me-2"></i>Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showUsers()">
                                <i class="fa-solid fa-users me-2"></i>Usuarios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showOrders()">
                                <i class="fa-solid fa-shopping-cart me-2"></i>Pedidos
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-md-9 col-lg-10 main-content">
                <!-- Dashboard -->
                <div id="dashboard-section" class="content-section active">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Total Productos</h6>
                                            <h2 id="totalProducts">0</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa-solid fa-box fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Total Usuarios</h6>
                                            <h2 id="totalUsers">0</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa-solid fa-users fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Total Pedidos</h6>
                                            <h2 id="totalOrders">0</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa-solid fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Ventas Total</h6>
                                            <h2 id="totalSales">$0.00</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fa-solid fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Pedidos Recientes</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentOrders">
                                        <!-- Los pedidos recientes se cargarán aquí -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Productos Más Vendidos</h5>
                                </div>
                                <div class="card-body">
                                    <div id="topProducts">
                                        <!-- Los productos más vendidos se cargarán aquí -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="products-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Gestión de Productos</h1>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fa-solid fa-plus me-2"></i>Agregar Producto
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Categoría</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <!-- Los productos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Gestión de Usuarios</h1>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fa-solid fa-user-plus me-2"></i>Agregar Usuario
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Nombre</th>
                                    <th>Apellido</th>
                                    <th>Cédula</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Los usuarios se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Gestión de Pedidos</h1>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Pedido #</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                                <!-- Los pedidos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para agregar/editar producto -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Precio *</label>
                                <input type="number" step="0.01" class="form-control" id="productPrice" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Código Único</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="productCode" placeholder="Se generará automáticamente" readonly>
                                    <button type="button" class="btn btn-outline-primary" onclick="generateNewCode()" title="Generar nuevo código">
                                        <i class="fa-solid fa-refresh"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="showCodeInfo()" title="Información sobre códigos">
                                        <i class="fa-solid fa-question-circle"></i>
                                    </button>
                                </div>
                                <small class="text-muted">El código se genera automáticamente si se deja vacío</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Categoría *</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="cocina">Cocina</option>
                                    <option value="refrigeracion">Refrigeración</option>
                                    <option value="lavanderia">Lavandería</option>
                                    <option value="climatizacion">Climatización</option>
                                    <option value="pequenos">Pequeños Electrodomésticos</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Stock *</label>
                                <input type="number" min="0" class="form-control" id="productStock" required placeholder="Cantidad disponible">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Imagen del Producto *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="productImage" placeholder="URL de imagen o capture/seleccione una foto" required readonly>
                                    <button type="button" class="btn btn-outline-primary" onclick="showImageOptions()">
                                        <i class="fa-solid fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview de imagen -->
                        <div class="row mt-3" id="imagePreviewContainer" style="display: none;">
                            <div class="col-12">
                                <label class="form-label">Vista previa:</label>
                                <div class="text-center">
                                    <img id="imagePreview" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    <br>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearImagePreview()">
                                        <i class="fa-solid fa-trash"></i> Eliminar imagen
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inputs ocultos para cámara y archivo -->
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        <video id="cameraVideo" width="300" height="200" autoplay style="display: none;"></video>
                        <canvas id="cameraCanvas" width="300" height="200" style="display: none;"></canvas>
                        <div class="mt-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Agregar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="editUserId">
                        
                        <!-- Foto del usuario -->
                        <div class="mb-3 text-center">
                            <label class="form-label">Foto del Usuario</label>
                            <div id="userPhotoContainer" class="mb-2">
                                <img id="userPhotoPreview" src="https://via.placeholder.com/150x150?text=Sin+Foto" alt="Foto del usuario" class="img-thumbnail rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="showUserImageOptions()">
                                    <i class="fa-solid fa-camera"></i> Cambiar foto
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearUserPhoto()">
                                    <i class="fa-solid fa-trash"></i> Eliminar
                                </button>
                            </div>
                            <input type="hidden" id="userPhoto" value="">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="userName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido *</label>
                                <input type="text" class="form-control" id="userLastName" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Cédula *</label>
                                <input type="text" class="form-control" id="userCedula" required maxlength="10" pattern="[0-9]{10}" title="Ingrese exactamente 10 dígitos">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="userPhone" required maxlength="10" pattern="[0-9]{10}" title="Ingrese exactamente 10 dígitos">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Contraseña <span id="passwordRequiredText">*</span></label>
                            <input type="password" class="form-control" id="userPassword">
                            <small class="text-muted" id="passwordHelp">Deje en blanco para mantener la contraseña actual</small>
                        </div>
                        
                        <!-- Elementos ocultos para cámara de usuario -->
                        <input type="file" id="userFileInput" accept="image/*" style="display: none;" onchange="handleUserFileSelect(event)">
                        <video id="userCameraVideo" width="300" height="200" autoplay style="display: none;"></video>
                        <canvas id="userCameraCanvas" width="300" height="200" style="display: none;"></canvas>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./static/js/productManager.js"></script>
    <script src="./static/js/product-codes.js"></script>
    <script src="./static/js/admin-new.js"></script>
    
    <script>
        // Función para generar nuevo código
        function generateNewCode() {
            const codeField = document.getElementById('productCode');
            const newCode = generateUniqueProductCode();
            codeField.value = newCode;
            
            Swal.fire({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                icon: 'success',
                title: 'Código generado',
                text: `Nuevo código: ${newCode}`
            });
        }
        
        // Limpiar formulario cuando se abre el modal
        document.getElementById('productModal').addEventListener('show.bs.modal', function() {
            const modalTitle = document.querySelector('#productModal .modal-title');
            if (modalTitle.textContent === 'Agregar Producto') {
                // Solo generar código automáticamente para productos nuevos
                setTimeout(() => {
                    generateNewCode();
                }, 100);
            }
        });
    </script>
</body>
</html>
